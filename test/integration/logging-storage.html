<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>Image Widget</title>

  <link rel="stylesheet" href="../../src/widget/css/styles.css">
  <link rel="stylesheet" href="../../src/components/widget-common/dist/css/message.css">

  <script src="../../src/components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../src/components/web-component-tester/browser.js"></script>

  <link rel="import" href="../../src/components/rise-storage/rise-storage.html">
</head>
<body>

  <rise-storage refresh="5"></rise-storage>

  <div id="container">
    <div id="image"></div>
  </div>

  <div id="messageContainer"></div>

  <script src="../data/storage.js"></script>

  <script src="../../node_modules/widget-tester/mocks/gadget-mocks.js"></script>
  <script src="../../node_modules/widget-tester/mocks/logger-mock.js"></script>

  <script src="../../src/config/test.js"></script>
  <script src="../../src/widget/image.js"></script>
  <script src="../../src/components/widget-common/dist/message.js"></script>
  <script src="../../src/widget/storage.js"></script>
  <script src="../../src/widget/main.js"></script>

  <script>
    var storage = document.querySelector("rise-storage");

    suite("logging", function() {
      var spy,
        table = "image_events",
        params = {
          "event": "error",
          "event_details": "rise storage error",
          "error_details": "The request failed with status code: 404",
          "file_url": "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-b428b4e8-c8b9-41d5-8a10-b4193c789443%2FWidgets%2Fsimpson's.jpg",
          "file_format": "jpg",
          "company_id": '"companyId"',
          "display_id": '"displayId"'
        };

      sinon.stub(storage.$.ping, "generateRequest", function () {
        storage._handlePingError();
      });

      teardown(function() {
        RiseVision.Common.Logger.log.restore();
      });

      suite("rise storage error", function() {
        var spyCall;

        test("should log a rise storage error", function() {
          spy = sinon.spy(RiseVision.Common.Logger, "log");

          storage.dispatchEvent(new CustomEvent("rise-storage-error", {
            "detail": {
              "request": {
                "url": "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-b428b4e8-c8b9-41d5-8a10-b4193c789443%2FWidgets%2Fsimpson's.jpg"
              },
              "error": {
                "currentTarget": {
                  "status": 404
                }
              }
            },
            "bubbles": true
          }));

          assert(spy.calledOnce);
          assert(spy.calledWith(table, params));
        });
      });

      suite("rise cache error", function() {
        var spyCall;

        test("should log a rise cache error", function() {
          spy = sinon.spy(RiseVision.Common.Logger, "log");

          storage.dispatchEvent(new CustomEvent("rise-cache-error", {
            "detail": {
              "request": {
                "url": "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-b428b4e8-c8b9-41d5-8a10-b4193c789443%2FWidgets%2Fsimpson's.jpg"
              },
              "error": {
                "currentTarget": {
                  "status": 404
                }
              }
            },
            "bubbles": true
          }));

          params.event_details = "rise cache error";

          assert(spy.calledOnce);
          assert(spy.calledWith(table, params));
        });
      });

      suite("storage file not found", function() {
        var spyCall;

        test("should log a storage file not found error", function() {
          spy = sinon.spy(RiseVision.Common.Logger, "log");

          storage.dispatchEvent(new CustomEvent("rise-storage-no-file", {
            "detail": "Widgets/simpson's.jpg",
            "bubbles": true
          }));

          params.event_details = "storage file not found";
          params.file_url = "Widgets/simpson's.jpg";
          delete params.error_details;

          assert(spy.calledOnce);
          assert(spy.calledWith(table, params));
        });
      });

      suite("storage file throttled", function() {
        var spyCall;

        test("should log a storage file throttled error", function() {
          spy = sinon.spy(RiseVision.Common.Logger, "log");

          storage.dispatchEvent(new CustomEvent("rise-storage-file-throttled", {
            "detail": window.gadget.settings.additionalParams.url,
            "bubbles": true
          }));

          params.event_details = "storage file throttled";
          params.file_url = "https://storage.googleapis.com/risemedialibrary-b428b4e8-c8b9-41d5-8a10-b4193c789443/Widgets%2Fsimpson's.jpg";

          assert(spy.calledOnce);
          assert(spy.calledWith(table, params));
        });
      });
    });
  </script>
</body>
</html>
